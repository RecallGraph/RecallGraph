<!DOCTYPE html>
<html lang="en">
<head><title>lib/operations/log/helpers</title></head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
<meta content="../../../" name="groc-relative-root">
<meta content="lib/operations/log/helpers" name="groc-document-path">
<meta content="lib/operations/log/helpers.js" name="groc-project-path">
<meta content="https://github.com/RecallGraph/RecallGraph" name="groc-github-url">
<link href="../../../assets/style.css" media="all" rel="stylesheet" type="text/css">
<script src="../../../assets/behavior.js" type="text/javascript"></script>
<body>
<div id="meta">
    <div class="file-path"><a
            href="https://github.com/RecallGraph/RecallGraph/blob/master/lib/operations/log/helpers.js">lib/operations/log/helpers.js</a>
    </div>
</div>
<div id="document">
    <div class="segment">
        <div class="code">
            <div class="wrapper"><span class="hljs-pi">'use strict'</span>

                <span class="hljs-keyword">const</span> { aql } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'@arangodb'</span>)

                <span class="hljs-keyword">const</span> { isString } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> { getLimitClause, getSort } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'../helpers'</span>)

                <span class="hljs-keyword">const</span> GROUP_BY = <span class="hljs-built_in">Object</span>.freeze({
                NODE: <span class="hljs-string">'v.meta.id'</span>,
                COLLECTION: <span class="hljs-string">'v.collection'</span>,
                EVENT: <span class="hljs-string">'v.event'</span>,
                TYPE: <span class="hljs-string">'collTypes[v.collection]'</span>
                })

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGroupExpr</span> (<span
                        class="hljs-params">groupByKey</span>) </span>{
                <span class="hljs-keyword">return</span> isString(groupByKey) &amp;&amp;
                GROUP_BY[groupByKey.toUpperCase()]
                }

                exports.getGroupExpr = getGroupExpr

                exports.getSortingClause = <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">getSortingClause</span> (<span
                        class="hljs-params">sort, groupBy, countsOnly</span>) </span>{
                <span class="hljs-keyword">const</span> sortDir = getSort(sort)
                <span class="hljs-keyword">const</span> groupExpr = getGroupExpr(groupBy)
                <span class="hljs-keyword">const</span> sortPrefix = (groupExpr || !countsOnly) ? <span
                        class="hljs-string">'sort '</span> : <span class="hljs-string">''</span>
                <span class="hljs-keyword">const</span> primarySort = getPrimarySort(sortPrefix, groupExpr, countsOnly,
                groupBy, sortDir)
                <span class="hljs-keyword">const</span> secondarySort = getSecondarySort(primarySort, groupExpr,
                countsOnly, groupBy)

                <span class="hljs-keyword">return</span> aql.literal(<span class="hljs-string">`<span
                        class="hljs-subst">${sortPrefix}</span><span class="hljs-subst">${primarySort}</span><span
                        class="hljs-subst">${secondarySort}</span>`</span>)
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPrimarySort</span> (<span
                        class="hljs-params">sortPrefix, groupExpr, countsOnly, groupBy, sortDir</span>) </span>{
                <span class="hljs-keyword">let</span> primarySort = <span class="hljs-string">''</span>

                <span class="hljs-keyword">if</span> (sortPrefix) {
                <span class="hljs-keyword">if</span> (countsOnly) {
                primarySort = <span class="hljs-string">'total'</span>
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (groupExpr) {
                primarySort = groupBy
                } <span class="hljs-keyword">else</span> {
                primarySort = <span class="hljs-string">'v.ctime'</span>
                }

                primarySort += <span class="hljs-string">` <span class="hljs-subst">${sortDir}</span>`</span>
                }

                <span class="hljs-keyword">return</span> primarySort
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSecondarySort</span> (<span
                        class="hljs-params">primarySort, groupExpr, countsOnly, groupBy</span>) </span>{
                <span class="hljs-keyword">let</span> secondarySort = <span class="hljs-string">''</span>

                <span class="hljs-keyword">if</span> (primarySort) {
                <span class="hljs-keyword">if</span> (groupExpr &amp;&amp; countsOnly) {
                secondarySort = <span class="hljs-string">`, <span class="hljs-subst">${groupBy}</span> asc`</span>
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(groupExpr ||
                countsOnly)) {
                secondarySort = <span class="hljs-string">', v._id asc'</span>
                }
                }

                <span class="hljs-keyword">return</span> secondarySort
                }

                exports.getGroupingClause = <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">getGroupingClause</span> (<span
                        class="hljs-params">groupBy, countsOnly</span>) </span>{
                <span class="hljs-keyword">const</span> groupExpr = getGroupExpr(groupBy)
                <span class="hljs-keyword">if</span> (groupExpr) {
                <span class="hljs-keyword">let</span> groupingSuffix

                <span class="hljs-keyword">if</span> (countsOnly) {
                groupingSuffix = <span class="hljs-string">'with count into total'</span>
                } <span class="hljs-keyword">else</span> {
                groupingSuffix = <span class="hljs-string">'into events = v'</span>
                }

                <span class="hljs-keyword">return</span> aql.literal(<span class="hljs-string">`collect <span
                        class="hljs-subst">${groupBy}</span> = <span class="hljs-subst">${groupExpr}</span> <span
                        class="hljs-subst">${groupingSuffix}</span>`</span>)
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (countsOnly) {
                <span class="hljs-keyword">return</span> aql.literal(<span class="hljs-string">'collect with count into total'</span>)
                }

                <span class="hljs-keyword">return</span> aql.literal(<span class="hljs-string">''</span>)
                }

                exports.getReturnClause = <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">getReturnClause</span> (<span class="hljs-params">groupBy, countsOnly, groupSort, groupSkip, groupLimit</span>) </span>{
                <span class="hljs-keyword">const</span> groupExpr = getGroupExpr(groupBy)
                <span class="hljs-keyword">let</span> returnClause

                <span class="hljs-keyword">if</span> (groupExpr) {
                <span class="hljs-keyword">if</span> (countsOnly) {
                returnClause = aql.literal(<span class="hljs-string">`return {<span class="hljs-subst">${groupBy}</span>, total}`</span>)
                } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">const</span> groupSortDir = getSort(groupSort)

                <span class="hljs-keyword">const</span> queryParts = [
                aql.literal(<span class="hljs-string">`return {<span
                        class="hljs-subst">${groupBy}</span>, events: (`</span>),
                aql.literal(<span class="hljs-string">`for ev in events sort ev.ctime <span class="hljs-subst">${groupSortDir}</span>`</span>)
                ]
                queryParts.push(getLimitClause(groupLimit, groupSkip))
                queryParts.push(aql.literal(<span class="hljs-string">'return ev)}'</span>))

                returnClause = aql.join(queryParts, <span class="hljs-string">' '</span>)
                }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (countsOnly) {
                returnClause = aql.literal(<span class="hljs-string">'return {total}'</span>)
                } <span class="hljs-keyword">else</span> {
                returnClause = aql.literal(<span class="hljs-string">'return v'</span>)
                }

                <span class="hljs-keyword">return</span> returnClause
                }
            </div>
        </div>
    </div>
</div>
</body>
</html>