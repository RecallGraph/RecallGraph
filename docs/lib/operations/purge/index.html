<!DOCTYPE html>
<html lang="en">
<head><title>lib/operations/purge/index</title></head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
<meta content="../../../" name="groc-relative-root">
<meta content="lib/operations/purge/index" name="groc-document-path">
<meta content="lib/operations/purge/index.js" name="groc-project-path">
<meta content="https://github.com/RecallGraph/RecallGraph" name="groc-github-url">
<link href="../../../assets/style.css" media="all" rel="stylesheet" type="text/css">
<script src="../../../assets/behavior.js" type="text/javascript"></script>
<body>
<div id="meta">
    <div class="file-path"><a
            href="https://github.com/RecallGraph/RecallGraph/blob/master/lib/operations/purge/index.js">lib/operations/purge/index.js</a>
    </div>
</div>
<div id="document">
    <div class="segment">
        <div class="code">
            <div class="wrapper"><span class="hljs-pi">'use strict'</span>

                <span class="hljs-keyword">const</span> { utils: { attachSpan, executeTransaction } } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'foxx-tracing'</span>)
                <span class="hljs-keyword">const</span> { getComponentTagOption } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../helpers'</span>)
                <span class="hljs-keyword">const</span> { SERVICE_COLLECTIONS } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../constants'</span>)
                <span class="hljs-keyword">const</span> { db } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'@arangodb'</span>)
                <span class="hljs-keyword">const</span> { set, chain, omit, get } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> log = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'../log'</span>)

                <span class="hljs-keyword">const</span> cto = getComponentTagOption(__filename)
                <span class="hljs-keyword">const</span> {
                events, commands, snapshots, snapshotLinks, evtSSLinks, skeletonVertices, skeletonEdgeHubs,
                skeletonEdgeSpokes
                } = SERVICE_COLLECTIONS

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">purge</span> (<span class="hljs-params">path = '/', { deleteUserObjects = false, silent = false } = {}</span>) </span>{
                <span class="hljs-keyword">let</span> nidGroups
                <span class="hljs-keyword">let</span> result = {}
                <span class="hljs-keyword">do</span> {
                nidGroups = log(path, { groupBy: <span class="hljs-string">'node'</span>, limit: <span
                        class="hljs-number">100</span> })

                <span class="hljs-keyword">const</span> txResult = executeTransaction({
                collections: {
                write: [
                events,
                commands,
                snapshots,
                snapshotLinks,
                evtSSLinks,
                skeletonVertices,
                skeletonEdgeHubs,
                skeletonEdgeSpokes
                ]
                },
                action: nidGroups =&gt; {
                <span class="hljs-keyword">const</span> { map } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> { getCollectionType } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../helpers'</span>)
                <span class="hljs-keyword">const</span> { COLLECTION_TYPES: { VERTEX, EDGE } } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../constants'</span>)
                <span class="hljs-keyword">const</span> {
                removeSkeletonVertices, removeSkeletonEdgeHubs, removeSkeletonEdgeSpokes, removeSnapshots,
                removeSnapshotLinks,
                removeEventSnapshotLinks, removeCommands, removeEvents
                } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers'</span>)

                <span class="hljs-keyword">const</span> svcResult = {}
                <span class="hljs-keyword">const</span> nids = map(nidGroups, <span class="hljs-string">'node'</span>)

                <span class="hljs-keyword">if</span> (deleteUserObjects) {
                svcResult.nids = nids
                }

                <span class="hljs-keyword">const</span> typeGroups = nids.reduce((acc, id) =&gt; {
                <span class="hljs-keyword">const</span> [coll] = id.split(<span class="hljs-string">'/'</span>)
                <span class="hljs-keyword">const</span> type = getCollectionType(coll)

                <span class="hljs-keyword">if</span> (!acc[type]) {
                acc[type] = []
                }
                acc[type].push(id)

                <span class="hljs-keyword">return</span> acc
                }, {})

                <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (typeGroups.hasOwnProperty(VERTEX)) {
                svcResult.sv = removeSkeletonVertices(typeGroups[VERTEX]).length
                }

                <span class="hljs-keyword">if</span> (typeGroups.hasOwnProperty(EDGE)) {
                <span class="hljs-keyword">const</span> seh = removeSkeletonEdgeHubs(typeGroups[EDGE])
                svcResult.seh = seh.length
                svcResult.ses = removeSkeletonEdgeSpokes(seh).length
                }

                <span class="hljs-keyword">const</span> ss = removeSnapshots(nids)
                svcResult.ss = ss.length

                svcResult.ssl = removeSnapshotLinks(ss).length
                svcResult.essl = removeEventSnapshotLinks(ss).length

                <span class="hljs-keyword">const</span> eids = nidGroups.flatMap(group =&gt; map(group.events, <span
                        class="hljs-string">'_id'</span>))
                svcResult.evt = removeEvents(eids).length

                svcResult.cmd = removeCommands(eids).length

                <span class="hljs-keyword">return</span> svcResult
                } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-built_in">console</span>.error(e.stack)

                <span class="hljs-keyword">throw</span> e
                }
                },
                params: nidGroups
                })

                <span class="hljs-keyword">if</span> (!silent) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span
                        class="hljs-keyword">in</span> omit(txResult, <span class="hljs-string">'nids'</span>)) {
                <span class="hljs-keyword">if</span> (!result[key]) {
                result[key] = <span class="hljs-number">0</span>
                }

                result[key] += txResult[key]
                }
                }

                <span class="hljs-keyword">if</span> (deleteUserObjects) {
                <span class="hljs-keyword">const</span> collGroups = txResult.nids.reduce((acc, id) =&gt; {
                <span class="hljs-keyword">const</span> [coll, key] = id.split(<span class="hljs-string">'/'</span>)

                <span class="hljs-keyword">if</span> (!acc[coll]) {
                acc[coll] = []
                }
                acc[coll].push(key)

                <span class="hljs-keyword">return</span> acc
                }, {})

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> coll <span
                        class="hljs-keyword">in</span> collGroups) {
                <span class="hljs-keyword">const</span> deleted = db._collection(coll).remove(collGroups[coll])
                <span class="hljs-keyword">const</span> dCount = chain(deleted).map(<span
                        class="hljs-string">'_key'</span>).compact().size().value()

                <span class="hljs-keyword">if</span> (!get(result, [<span class="hljs-string">'user'</span>, coll])) {
                set(result, [<span class="hljs-string">'user'</span>, coll], <span class="hljs-number">0</span>)
                }

                result.user[coll] += dCount
                }
                }
                } <span class="hljs-keyword">while</span> (nidGroups.length)

                <span class="hljs-keyword">return</span> silent ? {} : result
                }

                <span class="hljs-built_in">module</span>.exports = attachSpan(purge, <span
                        class="hljs-string">'purge'</span>, cto)
            </div>
        </div>
    </div>
</div>
</body>
</html>