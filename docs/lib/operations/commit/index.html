<!DOCTYPE html>
<html lang="en">
<head><title>lib/operations/commit/index</title></head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
<meta content="../../../" name="groc-relative-root">
<meta content="lib/operations/commit/index" name="groc-document-path">
<meta content="lib/operations/commit/index.js" name="groc-project-path">
<meta content="https://github.com/RecallGraph/RecallGraph" name="groc-github-url">
<link href="../../../assets/style.css" media="all" rel="stylesheet" type="text/css">
<script src="../../../assets/behavior.js" type="text/javascript"></script>
<body>
<div id="meta">
    <div class="file-path"><a
            href="https://github.com/RecallGraph/RecallGraph/blob/master/lib/operations/commit/index.js">lib/operations/commit/index.js</a>
    </div>
</div>
<div id="document">
    <div class="segment">
        <div class="code">
            <div class="wrapper"><span class="hljs-pi">'use strict'</span>

                <span class="hljs-keyword">const</span> { getComponentTagOption } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../helpers'</span>)
                <span class="hljs-keyword">const</span> { SERVICE_COLLECTIONS, EVENTS: { CREATED, UPDATED } } = <span
                        class="hljs-built_in">require</span>(
                <span class="hljs-string">'../../constants'</span>)
                <span class="hljs-keyword">const</span> { pickBy, has } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> { utils: { attachSpan, executeTransaction } } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'foxx-tracing'</span>)

                <span class="hljs-keyword">const</span> cto = getComponentTagOption(__filename)
                <span class="hljs-keyword">const</span> {
                events, commands, snapshots, snapshotLinks, evtSSLinks, skeletonVertices, skeletonEdgeHubs,
                skeletonEdgeSpokes
                } = SERVICE_COLLECTIONS

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">commit</span> (<span class="hljs-params">collName, node, op, {
  returnNew = false,
  returnOld = false,
  silent = false
} = {},
options = {}</span>) </span>{
                <span class="hljs-keyword">const</span> result = executeTransaction({
                collections: {
                write: [
                collName,
                events,
                commands,
                snapshots,
                snapshotLinks,
                evtSSLinks,
                skeletonVertices,
                skeletonEdgeHubs,
                skeletonEdgeSpokes
                ]
                },
                action: params =&gt; {
                <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> { pick, has, omit, assign } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> { getCollectionType } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'../../helpers'</span>)
                <span class="hljs-keyword">const</span> {
                DB_OPS: { INSERT, REPLACE, REMOVE, UPDATE, RESTORE }, COLLECTION_TYPES: { EDGE }
                } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../constants'</span>)
                <span class="hljs-keyword">const</span> {
                prepInsert, prepReplace, prepRemove, prepUpdate, prepRestore, insertEventNode, insertCommandEdge,
                insertEvtSSLink, metaize, updateSkeletonGraph
                } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers'</span>)

                <span class="hljs-keyword">const</span> prepOpMap = {
                [INSERT]: prepInsert,
                [REPLACE]: prepReplace,
                [REMOVE]: prepRemove,
                [UPDATE]: prepUpdate,
                [RESTORE]: prepRestore
                }

                <span class="hljs-keyword">const</span> { op, collName, node, options } = params
                <span class="hljs-keyword">if</span> (has(prepOpMap, op)) {
                <span class="hljs-keyword">const</span> { result, event, time, prevEvent, ssData } =
                prepOpMap[op](collName, node, options)
                <span class="hljs-keyword">const</span> meta = metaize(omit(result, <span
                        class="hljs-string">'new'</span>, <span class="hljs-string">'old'</span>))

                <span class="hljs-keyword">if</span> (getCollectionType(collName) === EDGE) {
                <span class="hljs-keyword">switch</span> (event) {
                <span class="hljs-keyword">case</span> CREATED:
                assign(meta, metaize(pick(result.new, <span class="hljs-string">'_from'</span>, <span
                        class="hljs-string">'_to'</span>)))

                <span class="hljs-keyword">break</span>

                <span class="hljs-keyword">case</span> UPDATED:
                <span class="hljs-keyword">if</span> (result.new._from !== result.old._from) {
                meta.fromNew = result.new._from
                meta.fromOld = result.old._from
                }
                <span class="hljs-keyword">if</span> (result.new._to !== result.old._to) {
                meta.toNew = result.new._to
                meta.toOld = result.old._to
                }

                <span class="hljs-keyword">break</span>
                }
                }

                <span class="hljs-keyword">const</span> evtNode = insertEventNode(meta, time, event, ssData, prevEvent,
                collName)

                insertCommandEdge(prevEvent, evtNode, result.old, result.new)

                <span class="hljs-keyword">if</span> (ssData.ssNode &amp;&amp; ssData.hopsFromLast === <span
                        class="hljs-number">1</span>) {
                insertEvtSSLink(evtNode._id, ssData.ssNode._id)
                }

                updateSkeletonGraph(evtNode)

                <span class="hljs-keyword">return</span> result
                }
                } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-built_in">console</span>.error(e.stack)

                <span class="hljs-keyword">throw</span> e
                }
                },
                params: {
                collName,
                node,
                op,
                options
                }
                })

                <span class="hljs-keyword">if</span> (!silent) {
                <span class="hljs-keyword">const</span> keyMap = {
                old: returnOld,
                <span class="hljs-keyword">new</span>: returnNew
                }

                <span class="hljs-keyword">return</span> pickBy(result, (value, key) =&gt;
                has(keyMap, key) ? keyMap[key] : <span class="hljs-literal">true</span>
                )
                } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> {}
                }
                }

                <span class="hljs-built_in">module</span>.exports = attachSpan(commit, <span class="hljs-string">'commit'</span>,
                cto)
            </div>
        </div>
    </div>
</div>
</body>
</html>