<!DOCTYPE html>
<html lang="en">
<head><title>lib/routes/helpers</title></head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
<meta content="../../" name="groc-relative-root">
<meta content="lib/routes/helpers" name="groc-document-path">
<meta content="lib/routes/helpers.js" name="groc-project-path">
<meta content="https://github.com/RecallGraph/RecallGraph" name="groc-github-url">
<link href="../../assets/style.css" media="all" rel="stylesheet" type="text/css">
<script src="../../assets/behavior.js" type="text/javascript"></script>
<body>
<div id="meta">
    <div class="file-path"><a href="https://github.com/RecallGraph/RecallGraph/blob/master/lib/routes/helpers.js">lib/routes/helpers.js</a>
    </div>
</div>
<div id="document">
    <div class="segment">
        <div class="code">
            <div class="wrapper"><span class="hljs-pi">'use strict'</span>

                <span class="hljs-keyword">const</span> { chain, find } = <span
                        class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
                <span class="hljs-keyword">const</span> { getAST } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'../operations/helpers'</span>)
                <span class="hljs-keyword">const</span> Joi = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'joi'</span>)
                <span class="hljs-keyword">const</span> { db } = <span class="hljs-built_in">require</span>(<span
                        class="hljs-string">'@arangodb'</span>)
            </div>
        </div>
    </div>
    <div class="segment">
        <div class="comments ">
            <div class="wrapper"><p>Public</p></div>
        </div>
        <div class="code">
            <div class="wrapper"><span class="hljs-keyword">const</span> getCRUDErrors = <span
                    class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCRUDErrors</span> (<span
                    class="hljs-params">result</span>) </span>{
                <span class="hljs-keyword">return</span> chain(result).map(<span class="hljs-string">'errorNum'</span>).compact().countBy().map((val,
                key) =&gt; <span class="hljs-string">`<span class="hljs-subst">${key}</span>:<span class="hljs-subst">${val}</span>`</span>).join().value()
                }

                <span class="hljs-keyword">const</span> JoiRG = Joi.extend(Joi =&gt; ({
                base: Joi.string(),
                name: <span class="hljs-string">'string'</span>,
                language: {
                filter: <span class="hljs-string">'must be a valid filter expression (see docs).'</span>,
                collection: <span class="hljs-string">'collection does not exist in DB.'</span>
                },
                rules: [
                {
                name: <span class="hljs-string">'filter'</span>,
                validate (params, value, state, options) {
                <span class="hljs-keyword">try</span> {
                getAST(value)

                <span class="hljs-keyword">return</span> value
                } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-built_in">console</span>.error(e.stack)

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.createError(<span
                        class="hljs-string">'string.filter'</span>, { v: value }, state, options)
                }
                }
                },
                {
                name: <span class="hljs-string">'collection'</span>,
                validate (params, value, state, options) {
                <span class="hljs-keyword">const</span> coll = db._collection(value)
                <span class="hljs-keyword">if</span> (!coll) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.createError(<span
                        class="hljs-string">'string.collection'</span>, { v: value }, state, options)
                }

                <span class="hljs-keyword">return</span> value
                }
                }
                ]
                }))

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span
                        class="hljs-title">validate</span> (<span class="hljs-params">values, schemas</span>) </span>{
                <span class="hljs-keyword">const</span> results = {
                valid: <span class="hljs-literal">true</span>,
                values: [],
                errors: []
                }

                values.forEach((value, i) =&gt; {
                <span class="hljs-keyword">const</span> schema = schemas[i]
                <span class="hljs-keyword">const</span> res = JoiRG.validate(value, schema)

                results.values.push(res.value)
                results.errors.push(res.error)

                <span class="hljs-keyword">if</span> (res.error) {
                results.valid = <span class="hljs-literal">false</span>
                }
                })

                <span class="hljs-keyword">return</span> results
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkValidation</span> (<span
                        class="hljs-params">result</span>) </span>{
                <span class="hljs-keyword">if</span> (!result.valid) {
                <span class="hljs-keyword">throw</span> find(result.errors)
                }
                }

                <span class="hljs-built_in">module</span>.exports = {
                getCRUDErrors,
                JoiRG,
                validate,
                checkValidation
                }
            </div>
        </div>
    </div>
</div>
</body>
</html>